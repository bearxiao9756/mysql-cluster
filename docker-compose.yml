version: '3.8'

services:
  # --- MySQL MGR 节点 1 ---
  mysql1:
    image: registry.cn-shanghai.aliyuncs.com/wukongim/mysql:8.0.33
    container_name: mysql1
    # 宿主机端口映射，方便管理
    ports: 
      - "3306:3306"
    environment:
      # 数据库初始化
      MYSQL_ROOT_PASSWORD: Root_Password_123
      # MGR 恢复账号 (与 init.sql 对应)
      GROUP_REPLICATION_RECOVERY_USER: repl_mgr
      GROUP_REPLICATION_RECOVERY_PASSWORD: MGR_Password_123
      # 覆盖 my.cnf 中的配置，为每个节点设置唯一的 ID 和地址
      MYSQL_INIT_SQL: |
        SET GLOBAL server_id = 1;
        SET GLOBAL group_replication_local_address = 'mysql1:3306';
    volumes:
      - ./my.cnf:/etc/mysql/my.cnf
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mysql_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pRoot_Password_123"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- MySQL MGR 节点 2 ---
  mysql2:
    image: registry.cn-shanghai.aliyuncs.com/wukongim/mysql:8.0.33
    container_name: mysql2
    environment:
      MYSQL_ROOT_PASSWORD: Root_Password_123
      GROUP_REPLICATION_RECOVERY_USER: repl_mgr
      GROUP_REPLICATION_RECOVERY_PASSWORD: MGR_Password_123
      MYSQL_INIT_SQL: |
        SET GLOBAL server_id = 2;
        SET GLOBAL group_replication_local_address = 'mysql2:3306';
    volumes:
      - ./my.cnf:/etc/mysql/my.cnf
    networks:
      - mysql_network
    depends_on:
      mysql1:
        condition: service_healthy

  # --- MySQL MGR 节点 3 ---
  mysql3:
    image: registry.cn-shanghai.aliyuncs.com/wukongim/mysql:8.0.33
    container_name: mysql3
    environment:
      MYSQL_ROOT_PASSWORD: Root_Password_123
      GROUP_REPLICATION_RECOVERY_USER: repl_mgr
      GROUP_REPLICATION_RECOVERY_PASSWORD: MGR_Password_123
      MYSQL_INIT_SQL: |
        SET GLOBAL server_id = 3;
        SET GLOBAL group_replication_local_address = 'mysql3:3306';
    volumes:
      - ./my.cnf:/etc/mysql/my.cnf
    networks:
      - mysql_network
    depends_on:
      mysql1:
        condition: service_healthy

  # --- ProxySQL 代理层 ---
  proxysql:
    image: proxysql/proxysql:2.5
    container_name: proxysql
    # 宿主机端口映射 (3306 是应用连接端口, 6032 是管理端口)
    ports:
      - "6033:6033"
      - "6032:6032"
    environment:
      # ProxySQL 启动时运行的脚本，用于配置 MGR 监控和读写路由
      # 注意：在生产环境中，这些配置应放在独立的配置文件中或通过管理端口导入
      PROXYSQL_CONFIG: |
        -- 配置 ProxySQL 管理员
        UPDATE global_variables SET admin-admin_credentials='admin:admin_password' WHERE variable_name='admin-admin_credentials';
        
        -- 配置 MySQL 监控用户
        UPDATE global_variables SET mysql-monitor_username='monitor', mysql-monitor_password='Monitor_Password_123' WHERE variable_name IN ('mysql-monitor_username', 'mysql-monitor_password');

        -- 添加应用用户 (应用连接 ProxySQL 时使用的用户)
        INSERT INTO mysql_users (username, password, default_hostgroup) VALUES ('app_user', 'App_Password_123', 10);

        -- 配置 MGR 监控：使用 hostgroup 10 (Master) 和 hostgroup 20 (Replica)
        -- 监控器将自动根据 MGR 状态将节点分配到这两个组
        INSERT INTO mysql_group_replication_hostgroups (writer_hostgroup, backup_writer_hostgroup, reader_hostgroup, offline_hostgroup, active) VALUES (10, 20, 20, 0, 1);
        
        -- 添加 MGR 节点到 ProxySQL 监控
        INSERT INTO mysql_servers (hostgroup_id, hostname, port) VALUES (0, 'mysql1', 3306);
        INSERT INTO mysql_servers (hostgroup_id, hostname, port) VALUES (0, 'mysql2', 3306);
        INSERT INTO mysql_servers (hostgroup_id, hostname, port) VALUES (0, 'mysql3', 3306);

        -- 读写分离规则：所有 SELECT 路由到从库组 (20)，其他路由到主库组 (10)
        INSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (10, 1, '^SELECT.*FOR UPDATE$', 10, 1);
        INSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (11, 1, '^SELECT', 20, 1);
        INSERT INTO mysql_query_rules (rule_id, active, match_digest, destination_hostgroup, apply) VALUES (12, 1, '.*', 10, 1);
        
        -- 立即加载并持久化配置
        LOAD MYSQL SERVERS TO RUNTIME;
        SAVE MYSQL SERVERS TO DISK;
        LOAD MYSQL USERS TO RUNTIME;
        SAVE MYSQL USERS TO DISK;
        LOAD MYSQL QUERY RULES TO RUNTIME;
        SAVE MYSQL QUERY RULES TO DISK;
        LOAD MYSQL GROUP REPLICATION HOSTGROUPS TO RUNTIME;
        SAVE MYSQL GROUP REPLICATION HOSTGROUPS TO DISK;

    networks:
      - mysql_network
    depends_on:
      mysql1:
        condition: service_healthy

networks:
  mysql_network:
    driver: bridge