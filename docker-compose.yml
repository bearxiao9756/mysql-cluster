version: '3.8'

services:
  # --- MySQL MGR 节点 1 ---
  mysql1:
    image: registry.cn-shanghai.aliyuncs.com/wukongim/mysql:8.0.33
    container_name: mysql1
    # 宿主机端口映射，方便管理
    ports: 
      - "3306:3306"
    environment:
      # 数据库初始化
      MYSQL_ROOT_PASSWORD: Root_Password_123
      # MGR 恢复账号 (与 init.sql 对应)
      GROUP_REPLICATION_RECOVERY_USER: repl_mgr
      GROUP_REPLICATION_RECOVERY_PASSWORD: MGR_Password_123
      # 覆盖 my.cnf 中的配置，为每个节点设置唯一的 ID 和地址
      MYSQL_INIT_SQL: |
        SET GLOBAL server_id = 1;
        SET GLOBAL group_replication_local_address = 'mysql1:3306';
    volumes:
      - ./my.cnf:/etc/mysql/my.cnf
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mysql_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pRoot_Password_123"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- MySQL MGR 节点 2 ---
  mysql2:
    image: registry.cn-shanghai.aliyuncs.com/wukongim/mysql:8.0.33
    container_name: mysql2
    environment:
      MYSQL_ROOT_PASSWORD: Root_Password_123
      GROUP_REPLICATION_RECOVERY_USER: repl_mgr
      GROUP_REPLICATION_RECOVERY_PASSWORD: MGR_Password_123
      MYSQL_INIT_SQL: |
        SET GLOBAL server_id = 2;
        SET GLOBAL group_replication_local_address = 'mysql2:3306';
    volumes:
      - ./my.cnf:/etc/mysql/my.cnf
    networks:
      - mysql_network
    depends_on:
      mysql1:
        condition: service_healthy

  # --- MySQL MGR 节点 3 ---
  mysql3:
    image: registry.cn-shanghai.aliyuncs.com/wukongim/mysql:8.0.33
    container_name: mysql3
    environment:
      MYSQL_ROOT_PASSWORD: Root_Password_123
      GROUP_REPLICATION_RECOVERY_USER: repl_mgr
      GROUP_REPLICATION_RECOVERY_PASSWORD: MGR_Password_123
      MYSQL_INIT_SQL: |
        SET GLOBAL server_id = 3;
        SET GLOBAL group_replication_local_address = 'mysql3:3306';
    volumes:
      - ./my.cnf:/etc/mysql/my.cnf
    networks:
      - mysql_network
    depends_on:
      mysql1:
        condition: service_healthy

  # --- ProxySQL 代理层 ---
  proxysql:
    image: proxysql/proxysql:2.5
    container_name: proxysql
    # 宿主机端口映射 (6033是应用连接端口, 6032是管理端口)
    ports: 
      - "6033:6033"
      - "6032:6032" 
    volumes:
      # 挂载 SQL 配置文件和加载脚本
      - ./init-proxysql.sql:/etc/proxysql/init-proxysql.sql:ro
      - ./load-proxysql.sh:/usr/local/bin/load-proxysql.sh:ro
    environment:
      # 保持 environment 块为空或删除，以避免格式问题。
      # 所有配置都已移至脚本。
      # 这里可以添加 ProxySQL 镜像所需的其他环境变量（如果需要）
      # 例如：- PROXYSQL_ENABLE_DUMMY_SETUP=true
      {}
    networks:
      - mysql_network
    depends_on:
      mysql1:
        condition: service_healthy

    # 关键修改：覆盖默认启动命令，先启动 proxysql，再执行配置脚本
    command: /bin/bash -c "proxysql & /usr/local/bin/load-proxysql.sh && fg"
    
networks:
  mysql_network:
    driver: bridge